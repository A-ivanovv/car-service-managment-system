{% load sklad_filters %}
<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Статистики за импорт - Автосервиз</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{% url 'dashboard' %}">
                <i class="fas fa-wrench me-2"></i>Автосервиз
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{% url 'dashboard' %}">
                    <i class="fas fa-home me-1"></i>Начало
                </a>
                <a class="nav-link" href="{% url 'sklad' %}">
                    <i class="fas fa-warehouse me-1"></i>Склад
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1>
                        <i class="fas fa-chart-bar me-3"></i>
                        Статистики за импорт
                    </h1>
                    <div class="btn-group">
                        <a href="{% url 'sklad' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Назад към склада
                        </a>
                        <a href="{% url 'sklad_import_bulk_delete' %}" class="btn btn-danger">
                            <i class="fas fa-trash me-2"></i>Изтрий всички
                        </a>
                    </div>
                </div>


                <!-- Overall Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h4 class="card-title">{{ total_imports }}</h4>
                                        <p class="card-text">Общо импорти</p>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-file-import fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h4 class="card-title">{{ successful_imports }}</h4>
                                        <p class="card-text">Успешни импорти</p>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-check-circle fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h4 class="card-title">{{ total_items_created }}</h4>
                                        <p class="card-text">Създадени артикули</p>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-plus-circle fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h4 class="card-title">{{ total_items_updated }}</h4>
                                        <p class="card-text">Обновени артикули</p>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-edit fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Provider Statistics -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h3 class="mb-3">
                            <i class="fas fa-truck me-2"></i>
                            Статистики по доставчици
                        </h3>
                    </div>
                </div>

                <div class="row mb-4">
                    {% for provider_code, provider_data in latest_imports.items %}
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-building me-2"></i>
                                    {{ provider_data.name }}
                                </h5>
                            </div>
                            <div class="card-body">
                                {% if provider_data.import %}
                                <div class="mb-3">
                                    <h6 class="text-muted">Последен импорт:</h6>
                                    <p class="mb-1">
                                        <strong>Дата на фактурата:</strong> 
                                        {{ provider_data.import.invoice_date|date:"d.m.Y" }}
                                    </p>
                                    <p class="mb-1">
                                        <strong>Импортиран на:</strong> 
                                        {{ provider_data.import.import_date|date:"d.m.Y H:i" }}
                                    </p>
                                    <p class="mb-1">
                                        <strong>Файл:</strong> 
                                        <small class="text-muted">{{ provider_data.import.file_name }}</small>
                                    </p>
                                </div>
                                
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="border-end">
                                            <h6 class="text-success">{{ provider_data.import.items_created }}</h6>
                                            <small class="text-muted">Създадени</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <h6 class="text-warning">{{ provider_data.import.items_updated }}</h6>
                                        <small class="text-muted">Обновени</small>
                                    </div>
                                </div>
                                {% else %}
                                <div class="text-center text-muted">
                                    <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                                    <p>Няма импорти от този доставчик</p>
                                </div>
                                {% endif %}
                            </div>
                            <div class="card-footer bg-light">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <small class="text-muted">Общо импорти</small>
                                        <div class="fw-bold">{{ provider_data.total_imports }}</div>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">Успешни</small>
                                        <div class="fw-bold text-success">{{ provider_data.successful_imports }}</div>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">Общо артикули</small>
                                        <div class="fw-bold">{{ provider_data.total_items_created|add:provider_data.total_items_updated }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            <i class="fas fa-info-circle me-2"></i>
                            Няма данни за импорти все още.
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Provider Filter -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="mb-0">
                                <i class="fas fa-history me-2"></i>
                                Последни импорти
                            </h3>
                            <form method="get" class="d-flex">
                                <select name="provider" class="form-select" onchange="this.form.submit()">
                                    <option value="">Всички доставчици</option>
                                    {% for code, name in provider_choices %}
                                    <option value="{{ code }}" {% if provider_filter == code %}selected{% endif %}>
                                        {{ name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Recent Imports -->
                <div class="row">
                    <div class="col-12">
                        
                        {% if recent_imports %}
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Доставчик</th>
                                                <th>Дата на фактурата</th>
                                                <th>Импортиран на</th>
                                                <th>Файл</th>
                                                <th>Създадени</th>
                                                <th>Обновени</th>
                                                <th>Грешки</th>
                                                <th>Пропуснати</th>
                                                <th>Статус</th>
                                                <th>Действия</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for import in recent_imports %}
                                            <tr>
                                                <td>
                                                    <span class="badge bg-primary">
                                                        {{ import.get_provider_display }}
                                                    </span>
                                                </td>
                                                <td>{{ import.invoice_date|date:"d.m.Y" }}</td>
                                                <td>{{ import.import_date|date:"d.m.Y H:i" }}</td>
                                                <td>
                                                    <small class="text-muted">{{ import.file_name }}</small>
                                                </td>
                                                <td>
                                                    <span class="badge bg-success">{{ import.items_created }}</span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-warning">{{ import.items_updated }}</span>
                                                </td>
                                                <td>
                                                    {% if import.errors_count > 0 %}
                                                    <span class="badge bg-danger">{{ import.errors_count }}</span>
                                                    {% else %}
                                                    <span class="badge bg-secondary">0</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if import.skipped_count > 0 %}
                                                    <span class="badge bg-info">{{ import.skipped_count }}</span>
                                                    {% else %}
                                                    <span class="badge bg-secondary">0</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if import.is_successful %}
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check me-1"></i>Успешен
                                                    </span>
                                                    {% else %}
                                                    <span class="badge bg-danger">
                                                        <i class="fas fa-times me-1"></i>Грешка
                                                    </span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div class="btn-group" role="group">
                                                        {% if import.is_successful and import.items_created|add:import.items_updated > 0 %}
                                                        <a href="{% url 'sklad_import_detail' import.id %}" class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-eye me-1"></i>Виж промени
                                                        </a>
                                                        {% endif %}
                                                        <a href="{% url 'sklad_import_delete' import.id %}" class="btn btn-sm btn-outline-danger" 
                                                           onclick="return confirm('Сигурни ли сте, че искате да изтриете този импорт?')">
                                                            <i class="fas fa-trash me-1"></i>Изтрий
                                                        </a>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-info text-center">
                            <i class="fas fa-info-circle me-2"></i>
                            Няма данни за импорти все още.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
